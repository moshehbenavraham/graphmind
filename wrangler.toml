# GraphMind API Configuration
# Cloudflare Workers project for voice-first knowledge assistant

name = "graphmind-api"
main = "src/index.js"
compatibility_date = "2024-11-10"

# Node.js compatibility for Workers
compatibility_flags = ["nodejs_compat"]

# D1 Database
[[d1_databases]]
binding = "DB"
database_name = "graphmind-db"
database_id = "5e0037ac-48c9-4e46-84ee-7aa41e517fc0"

# KV Namespaces
[[kv_namespaces]]
binding = "KV"
id = "bc58a6761f474954aafd55c2c1616108"

[[kv_namespaces]]
binding = "RATE_LIMIT"
id = "8da7913f421b47a88b723721946427de"

# R2 Bucket
[[r2_buckets]]
binding = "AUDIO_BUCKET"
bucket_name = "graphmind-audio"

# Durable Objects
# FalkorDB Connection Pool (Feature 003)
[[durable_objects.bindings]]
name = "FALKORDB_POOL"
class_name = "FalkorDBConnectionPool"
script_name = "graphmind-api"

# Durable Object Migrations
[[migrations]]
tag = "v3"
new_sqlite_classes = ["FalkorDBConnectionPool"]

[[migrations]]
tag = "v4"
new_sqlite_classes = ["VoiceSessionManager"]

[[migrations]]
tag = "v5"
new_sqlite_classes = ["QuerySessionManager"]

# Voice Session Manager (Feature 004 - Voice Note Capture)
[[durable_objects.bindings]]
name = "VOICE_SESSION"
class_name = "VoiceSessionManager"
script_name = "graphmind-api"

# Query Session Manager (Feature 008 - Voice Query Input)
[[durable_objects.bindings]]
name = "QUERY_SESSION_MANAGER"
class_name = "QuerySessionManager"
script_name = "graphmind-api"

# Workers AI
[ai]
binding = "AI"

# Cloudflare Queues (Feature 005 - Entity Extraction)
# Producer binding for enqueueing extraction jobs
[[queues.producers]]
binding = "ENTITY_EXTRACTION_QUEUE"
queue = "entity-extraction-jobs"

# Consumer configuration for processing extraction jobs
[[queues.consumers]]
queue = "entity-extraction-jobs"
max_batch_size = 10
max_retries = 3
dead_letter_queue = "entity-extraction-failed"

# Cloudflare Queues (Feature 006 - Knowledge Graph Building)
# Producer binding for enqueueing graph sync jobs
[[queues.producers]]
binding = "GRAPH_SYNC_QUEUE"
queue = "graph-sync-jobs"

# Consumer configuration for processing graph sync jobs
[[queues.consumers]]
queue = "graph-sync-jobs"
max_batch_size = 5
max_retries = 3
max_batch_timeout = 5
dead_letter_queue = "graph-sync-failed"

# Environment variables (non-sensitive)
[vars]
ENVIRONMENT = "development"

# Answer Generation Configuration (Feature 009)
ANSWER_CACHE_TTL = "3600"
ANSWER_MAX_TOKENS = "200"
LLM_TEMPERATURE = "0.7"
