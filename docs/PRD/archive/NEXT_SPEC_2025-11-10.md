# Next Spec: Authentication System

**Generated**: 2025-11-10
**Phase**: Phase 1 - Foundation
**Type**: Feature
**Priority**: P1 (Next to Build)

---

## Why This Next

**Dependencies Satisfied**:
- ‚úÖ Wrangler project initialized with Workers, D1, KV bindings
- ‚úÖ D1 database created with `users` and `sessions` tables
- ‚úÖ Project structure in place (`src/`, `migrations/`)
- ‚úÖ Basic Worker endpoints responding

**Blocks Future Work**:
- **ALL user-scoped features** depend on authentication
- Voice note capture (requires user_id to store notes)
- FalkorDB integration (requires user namespaces for data isolation)
- Personal knowledge graph (user-specific data)
- Voice queries (need to retrieve user's knowledge)

**Phase Requirement**:
- Phase 1 explicitly requires "User registration and authentication system"
- Security requirement: User data isolation (each user must have isolated FalkorDB namespace)
- Cannot proceed to voice capture without knowing which user is recording

---

## Scope Definition

### ‚úÖ Included

- **User Registration** - POST /api/auth/register endpoint with email/password
- **User Login** - POST /api/auth/login endpoint with JWT token generation
- **Password Security** - bcrypt hashing (cost factor 12)
- **JWT Token Management** - 24-hour expiration, stored in KV
- **Session Middleware** - Protect routes, extract user from token
- **FalkorDB Namespace Assignment** - Assign unique namespace to each user on registration
- **Basic Input Validation** - Email format, password strength, sanitization
- **Rate Limiting** - Login endpoint (5 attempts per 15 minutes)

### ‚ùå Excluded

- Email verification - Deferred to post-MVP polish phase
- Password reset flow - Future spec (Phase 4 polish)
- OAuth/social login - Future spec (Phase 5 advanced features)
- Multi-factor authentication - Future spec (Phase 5)
- Frontend UI components - Will be built with voice capture spec
- User profile management - Future spec (settings page)
- Session refresh tokens - Using simple 24-hour JWT for MVP

### üìè Size Check

**Estimated Complexity**: Medium
**Fits Single Context Window**: Yes

**Breakdown**:
- Authentication endpoints: ~5,000 tokens
- Password hashing + JWT utilities: ~3,000 tokens
- Session middleware: ~2,000 tokens
- Rate limiting logic: ~2,000 tokens
- Input validation: ~2,000 tokens
- Testing: ~4,000 tokens

**Total Estimated**: ~18,000 tokens (well within 30k limit)

---

## What /spec Needs to Know

**Spec Type**: Feature

**Core Goals** (will become full requirements in spec):
1. Secure user registration with bcrypt password hashing
2. JWT-based authentication with 24-hour sessions
3. Session middleware for protecting routes
4. Rate limiting to prevent brute-force attacks
5. Assign unique FalkorDB namespace per user for data isolation

**Key Components** (will be expanded in design):
- **Cloudflare Services**:
  - Workers: API endpoints (/api/auth/register, /api/auth/login, /api/auth/me)
  - D1: Store users, sessions
  - KV: Session cache, rate limiting counters
- **FalkorDB**: Namespace assignment (format: `user_<user_id>`)
- **Voice AI**: No
- **Frontend**: No (auth endpoints only, UI comes with voice capture spec)

**Success Criteria** (will become acceptance criteria):
- User can register with valid email/password
- Password is hashed with bcrypt (cost 12)
- User receives JWT token on login
- JWT token has 24-hour expiration
- Protected routes reject unauthenticated requests
- Rate limiting blocks after 5 failed login attempts
- Each user assigned unique FalkorDB namespace
- Duplicate email registrations rejected

---

## After This Spec

**Next Logical Steps** (in order):
1. **Voice Capture System** - WebRTC audio capture + Deepgram STT + real-time transcription
2. **Basic Frontend UI** - Registration, login, voice recording interface
3. **FalkorDB Connection Setup** - Connection pooling via Durable Objects

**Enables**:
- User-scoped voice note capture
- Personal knowledge graph creation
- Secure data isolation per user
- Protected API endpoints

---

## References

- **Phase Doc**: [docs/PRD/phases/phase-1-foundation.md](phases/phase-1-foundation.md)
- **PRD Section**: Section 3.1 User Management (FR-UM-001, FR-UM-002)
- **Technical Docs**:
  - [docs/PRD/technical/database-schemas.md](technical/database-schemas.md) (users table)
  - [docs/PRD/technical/api-specifications.md](technical/api-specifications.md) (auth endpoints)
- **Related Specs**: Builds on specs/001-wrangler-setup

---

## Notes

**Important Considerations**:

1. **JWT vs Sessions**: Using JWT for simplicity (no session store required beyond KV cache). Each token is self-contained. KV used for revocation and rate limiting only.

2. **FalkorDB Namespace Format**: Each user gets `user_<user_id>` namespace in FalkorDB for complete data isolation. This is critical for privacy and multi-tenancy.

3. **Password Security**: Using bcrypt with cost factor 12 (OWASP recommendation). This is computationally expensive but necessary for security. Consider using Workers with longer CPU time if bcrypt runs slow.

4. **Rate Limiting Strategy**:
   - Key format: `ratelimit:login:<email>` in KV
   - 5 attempts per 15 minutes
   - Reset counter on successful login
   - Return 429 Too Many Requests on limit exceeded

5. **Email Validation**: Basic regex validation for now. Not sending verification emails in MVP (deferred to Phase 4).

6. **No HTTPS in Local Dev**: Local development uses HTTP. Production will enforce HTTPS via Cloudflare.

**Trade-offs Made**:
- Simple JWT (no refresh tokens) - Easier to implement, sufficient for MVP
- No email verification - Reduces complexity, can add later
- Bcrypt in Workers - May have CPU limits, but Workers now support longer execution times
- KV for rate limiting - Simple but not distributed-safe (acceptable for MVP)

**Security Checklist**:
- ‚úÖ Password hashing with bcrypt (cost 12)
- ‚úÖ JWT with expiration (24 hours)
- ‚úÖ Rate limiting on login
- ‚úÖ Input validation (email, password)
- ‚úÖ SQL injection prevention (parameterized queries)
- ‚úÖ User data isolation (FalkorDB namespaces)
- ‚ö†Ô∏è No email verification (deferred)
- ‚ö†Ô∏è No HTTPS in local dev (production only)

---

**Ready to implement?** Run `/spec "Authentication System"` to create detailed spec with user stories, technical design, and implementation tasks.
