# PII Logging Policy

**Project**: GraphMind
**Created**: 2025-11-14
**Status**: Production Policy
**Compliance**: Privacy-First

---

## Overview

This document defines what personally identifiable information (PII) can be logged in production for GraphMind.

**Policy Goal**: Balance debugging/improvement needs with user privacy.

---

## What We Log ✅

### Query Metadata (SAFE - No PII)
```javascript
{
  query_id: "uuid",
  user_id: "uuid_hash", // Hashed user ID, not email
  timestamp: "ISO8601",
  latency_ms: 1234,
  cached: true,
  template_used: "relationship_query",
  entity_count: 5,
  relationship_count: 3,
  validation_passed: true,
  confidence_score: 0.95
}
```

### Cypher Queries (SEMI-SAFE)
```cypher
USE GRAPH user_abc_graph
MATCH (e:Person {name: 'Sarah'})-[:WORKS_ON]->(p:Project)
RETURN e, p
LIMIT 100
```

**Rationale**: Cypher queries may contain entity names but are essential for debugging query generation accuracy. Entity names alone don't identify users.

### Error Messages (SAFE)
```javascript
{
  error_type: "LLMTimeoutError",
  error_message: "LLM generation exceeded 5s timeout",
  query_id: "uuid",
  user_id: "uuid_hash"
}
```

### System Metrics (SAFE)
- Workers CPU time
- D1 query counts
- KV cache hit rates
- FalkorDB connection pool stats

---

## What We DO NOT Log ❌

### User Transcripts / Questions (PII)
**DO NOT LOG**: The actual voice transcripts or natural language questions

❌ BAD:
```javascript
console.log({
  question: "What projects did Sarah work on last week?"  // PII!
});
```

✅ GOOD:
```javascript
console.log({
  query_id: "abc-123",
  template_used: "relationship_query",
  entity_count: 2
});
```

**Rationale**: User questions may contain sensitive personal information. Not needed for debugging.

**Exception**: Can be logged if:
1. User explicitly opts in to "Share queries for improvement"
2. Stored separately with 30-day auto-deletion
3. Never sent to third-party services

---

### Query Results (PII)
**DO NOT LOG**: Full graph query results (entities, properties, relationships)

❌ BAD:
```javascript
console.log({
  results: {
    entities: [
      { name: "Sarah", role: "Engineer", salary: 120000 }  // PII!
    ]
  }
});
```

✅ GOOD:
```javascript
console.log({
  entity_count: 1,
  relationship_count: 3,
  result_size_bytes: 456
});
```

**Rationale**: Query results contain the user's personal knowledge graph. Privacy-critical.

---

### Generated Answers (PII)
**DO NOT LOG**: Natural language answers generated by LLM

❌ BAD:
```javascript
console.log({
  answer: "Sarah worked on 3 projects last week..."  // PII!
});
```

✅ GOOD:
```javascript
console.log({
  answer_length: 156,
  citation_count: 2,
  validation_passed: true
});
```

---

### Authentication Data (SECURITY)
**NEVER LOG**:
- JWT tokens (full or partial)
- Passwords (even hashed)
- API keys
- Session IDs
- User emails

---

## Production Logging Implementation

### QuerySessionManager.js
```javascript
// ✅ GOOD: Safe logging
function logQueryMetadata(query) {
  console.log(JSON.stringify({
    query_id: query.id,
    user_id: hashUserId(query.user_id), // Hash user ID
    latency_ms: query.latency_ms,
    cached: query.cached,
    template_used: query.template,
    entity_count: query.results?.entities?.length || 0,
    // question: query.question, // ❌ DO NOT LOG
    // results: query.results,    // ❌ DO NOT LOG
  }));
}
```

### AnswerGenerator.js
```javascript
// ✅ GOOD: Safe logging
function logAnswerGeneration(result) {
  console.log(JSON.stringify({
    query_id: result.query_id,
    answer_length: result.answer.length,
    citation_count: result.sources?.length || 0,
    validation_passed: result.validation_passed,
    confidence_score: result.confidence_score,
    generation_latency_ms: result.latency_ms,
    // answer: result.answer, // ❌ DO NOT LOG
  }));
}
```

### CypherGenerator.js
```javascript
// ⚠️ SEMI-SAFE: Log Cypher queries (may contain entity names)
function logCypherGeneration(cypher, template, user_id) {
  console.log(JSON.stringify({
    user_id: hashUserId(user_id),
    template_used: template,
    cypher_query: cypher, // ⚠️ May contain entity names (acceptable trade-off)
    cypher_length: cypher.length,
  }));
}
```

---

## User Opt-In for Question Logging (Future)

**If implementing opt-in question logging**:

1. **User Consent**:
   - Add account setting: "Share queries to improve GraphMind"
   - Default: OFF (opt-in required)
   - Can revoke consent anytime

2. **Separate Storage**:
   - Store in separate D1 table: `shared_queries`
   - Include: question, answer, timestamp, user_id (anonymized)
   - Auto-delete after 30 days

3. **Implementation**:
   ```javascript
   async function logQuestionIfOptedIn(user_id, question, answer) {
     const settings = await env.DB.prepare(
       'SELECT share_queries_for_improvement FROM user_settings WHERE user_id = ?'
     ).bind(user_id).first();

     if (settings?.share_queries_for_improvement) {
       await env.DB.prepare(`
         INSERT INTO shared_queries (user_id, question, answer, created_at)
         VALUES (?, ?, ?, datetime('now'))
       `).bind(anonymizeUserId(user_id), question, answer).run();
     }
   }
   ```

4. **Auto-Deletion**:
   ```sql
   -- Run daily via Cron Trigger
   DELETE FROM shared_queries
   WHERE created_at < datetime('now', '-30 days');
   ```

---

## Monitoring Compliance

### Code Review Checklist
Before merging any PR that adds logging:
- [ ] No `console.log(question)` or similar
- [ ] No `console.log(answer)` or similar
- [ ] No `console.log(results)` or similar
- [ ] No JWT tokens logged
- [ ] Only metadata logged (counts, latencies, IDs)

### Audit Log Review
Weekly audit of production logs:
- [ ] No questions appear in logs
- [ ] No answers appear in logs
- [ ] No full query results in logs
- [ ] No authentication tokens in logs

---

## Exceptions / Edge Cases

### 1. Critical Error Debugging
**Scenario**: Production bug that can't be reproduced without seeing user data

**Policy**:
- Can temporarily enable verbose logging for specific user_id
- Requires explicit user consent (email/support ticket)
- Must document in incident report
- Must delete logs after debugging complete

### 2. User Support Requests
**Scenario**: User reports incorrect answer and asks for help

**Policy**:
- User can share their query_id with support
- Support can look up query in D1 (already persisted)
- Never log additional PII without user permission

---

## Compliance with Privacy Laws

### GDPR (EU)
- ✅ No PII logged without consent
- ✅ User can request data deletion (include logs)
- ✅ Minimal data retention (logs auto-expire)

### CCPA (California)
- ✅ No PII sold or shared with third parties
- ✅ Users can opt out of analytics

### General Privacy Best Practices
- ✅ Data minimization (only log what's needed)
- ✅ Purpose limitation (only for debugging/improvement)
- ✅ Retention limits (logs auto-expire in 30 days)

---

## Cloudflare Workers Logs

**Cloudflare Logs Retention**: 24 hours (automatic)

**Production Logs Access**:
```bash
# Tail live logs
npx wrangler tail --env production

# Filter for errors only
npx wrangler tail --env production --status error
```

**Export for Analysis** (if needed):
- Use Cloudflare Logpush to export to R2/S3
- Ensure exported logs comply with this policy
- Auto-delete exported logs after 30 days

---

## Summary

**Log This** ✅:
- Query IDs, user IDs (hashed), timestamps
- Latencies, cache hit/miss, error types
- Entity/relationship counts (metadata)
- Cypher queries (acceptable: may contain entity names)

**Never Log This** ❌:
- User questions/transcripts
- Query results (entities, properties)
- Generated answers
- JWT tokens, passwords, emails

**When In Doubt**: Don't log it. Ask team lead first.

---

**Last Updated**: 2025-11-14
**Next Review**: 2026-02-14 (3 months)
**Owner**: Engineering Team
